- name: Stop PostgreSQL before replication
  service:
    name: postgresql
    state: stopped
  become: yes

- name: Remove old data directory
  file:
    path: "{{ postgresql_data_dir }}"
    state: absent
  become: yes

- name: Run base backup from master
  shell: |
    pg_basebackup \
      -h {{ hostvars[groups['role_master'][0]].ansible_host }} \
      -D {{ postgresql_data_dir }} \
      -U {{ replication_user }} \
      -Fp -Xs -R -P
  environment:
    PGPASSWORD: "{{ replication_password }}"
  become: yes
  # REMOVE THIS â†’ become_user: postgres  (This was causing ACL chmod crash)

- name: Start PostgreSQL
  service:
    name: postgresql
    state: started
  become: yes
